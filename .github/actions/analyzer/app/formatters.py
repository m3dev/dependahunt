"""
å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢é€£ã®é–¢æ•°
"""

import re
from typing import Dict, Any, List, Tuple

from cve_analyzer import translate_severity_to_japanese


def format_github_comment(analysis_result: str, pr_number: int, pr_title: str, repo: str = "", cve_info_list: List[Tuple[str, int, str]] = None) -> str:
    """GitHub ã‚³ãƒ¡ãƒ³ãƒˆç”¨ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

    Args:
        analysis_result: åˆ†æçµæœ
        pr_number: PRç•ªå·
        pr_title: PRã‚¿ã‚¤ãƒˆãƒ«
        repo: ãƒªãƒã‚¸ãƒˆãƒªåï¼ˆowner/repoå½¢å¼ï¼‰
        cve_info_list: [(cve_id, alert_number, alert_url), ...] ã®ãƒªã‚¹ãƒˆ
    """

    # ã‚¿ã‚¤ãƒˆãƒ«éƒ¨åˆ†ã®ç”Ÿæˆ
    title = "# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æçµæœ"
    if cve_info_list:
        # Alertç•ªå·ã¨URLã‚’å–å¾—ï¼ˆé‡è¤‡ã‚’é™¤å»ï¼‰
        alert_dict = {}  # {alert_number: alert_url}
        for _, alert_number, alert_url in cve_info_list:
            if alert_number > 0 and alert_url:
                alert_dict[alert_number] = alert_url

        # Alertç•ªå·ã®ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
        if alert_dict:
            alert_links = [f"[#{num}]({url})" for num, url in sorted(alert_dict.items())]
            title = f"# Dependabot Alert {', '.join(alert_links)} ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æçµæœ"

    comment = f"""{title}

**PR**: #{pr_number} - {pr_title}

{analysis_result}

---

*This comment was automatically generated by dependahunt.*
"""
    return comment


def format_cve_info_section(all_vuln_data: List[Dict[str, Any]]) -> str:
    """CVEåŸºæœ¬æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"""
    if not all_vuln_data:
        return ""

    result = "## ğŸ“‹ CVEåŸºæœ¬æƒ…å ±\n\n"
    for vuln_info in all_vuln_data:
        severity_jp = translate_severity_to_japanese(vuln_info['severity'])
        result += f"### {vuln_info['id']}\n"
        result += f"**ğŸ”— CVEè©³ç´°**: https://nvd.nist.gov/vuln/detail/{vuln_info['id']}\n"
        result += f"**CVSSåŸºæº–é‡è¦åº¦**: {severity_jp}\n"
        result += f"**å…¬é–‹æ—¥**: {vuln_info['published'][:10] if vuln_info['published'] != 'Unknown' else 'ä¸æ˜'}\n"
        result += f"**èª¬æ˜**: {vuln_info['description'][:200]}{'...' if len(vuln_info['description']) > 200 else ''}\n\n"

    return result
