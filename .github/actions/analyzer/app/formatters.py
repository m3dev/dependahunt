"""
å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢é€£ã®é–¢æ•°
"""

import json
from typing import Dict, Any, List, Tuple

from cve_analyzer import translate_severity_to_japanese
import markers


def format_github_comment(analysis_result: str, pr_number: int, pr_title: str, repo: str, version_info: Dict[str, str], cve_info_list: List[Tuple[str, int, str]] = None) -> str:
    """GitHub ã‚³ãƒ¡ãƒ³ãƒˆç”¨ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

    Args:
        analysis_result: åˆ†æçµæœ
        pr_number: PRç•ªå·
        pr_title: PRã‚¿ã‚¤ãƒˆãƒ«
        repo: ãƒªãƒã‚¸ãƒˆãƒªåï¼ˆowner/repoå½¢å¼ï¼‰
        version_info: ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ± {'package': 'name', 'from': '1.0', 'to': '2.0'}
        cve_info_list: [(cve_id, alert_number, alert_url), ...] ã®ãƒªã‚¹ãƒˆ
    """

    # ã‚¿ã‚¤ãƒˆãƒ«éƒ¨åˆ†ã®ç”Ÿæˆ
    package_name = version_info.get('package', '')
    package_version = version_info.get('from', '')

    alert_dict = {}  # {alert_number: alert_url}
    if cve_info_list:
        # Alertç•ªå·ã¨URLã‚’å–å¾—ï¼ˆé‡è¤‡ã‚’é™¤å»ï¼‰
        for _, alert_number, alert_url in cve_info_list:
            if alert_number > 0 and alert_url:
                alert_dict[alert_number] = alert_url


    comment = f"""# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æçµæœ

**Package**: {package_name} {package_version}
**Dependabot Alert**: {', '.join([f"[#{num}]({url})" for num, url in sorted(alert_dict.items())]) if alert_dict else 'N/A'}

{analysis_result}

---

*This comment was automatically generated by dependahunt.*
{markers.ANALYZED_PACKAGE.create(version_info)}
"""
    return comment


def format_cve_info_section(all_vuln_data: List[Dict[str, Any]]) -> str:
    """CVEåŸºæœ¬æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"""
    if not all_vuln_data:
        return ""

    result = "## ğŸ“‹ CVEåŸºæœ¬æƒ…å ±\n\n"
    for vuln_info in all_vuln_data:
        severity_jp = translate_severity_to_japanese(vuln_info['severity'])
        result += f"### {vuln_info['id']}\n"
        result += f"**ğŸ”— CVEè©³ç´°**: https://nvd.nist.gov/vuln/detail/{vuln_info['id']}\n"
        result += f"**CVSSåŸºæº–é‡è¦åº¦**: {severity_jp}\n"
        result += f"**å…¬é–‹æ—¥**: {vuln_info['published'][:10] if vuln_info['published'] != 'Unknown' else 'ä¸æ˜'}\n"
        result += f"**èª¬æ˜**: {vuln_info['description'][:200]}{'...' if len(vuln_info['description']) > 200 else ''}\n\n"

    return result
