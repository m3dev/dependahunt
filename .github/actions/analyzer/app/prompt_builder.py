"""
AI分析プロンプトの生成
"""

from typing import Dict, Any, List
from cve_analyzer import translate_severity_to_japanese


def create_ai_analysis_prompt(vuln_data: List[Dict[str, Any]], version_info: Dict[str, str],
                              additional_comment: str = None, previous_analysis: str = None) -> str:
    """CVE脆弱機能分析用のプロンプトを作成

    Args:
        vuln_data: 脆弱性データのリスト
        version_info: パッケージバージョン情報 {'package': 'name', 'from': '1.0', 'to': '2.0'} (必須)
        additional_comment: 追加の分析指示
        previous_analysis: 前回の分析結果
    """

    # 前回分析と追加質問の両方がある場合は、Q&A形式のプロンプトを使用
    if previous_analysis and additional_comment:
        return create_followup_question_prompt(vuln_data, previous_analysis, additional_comment)

    # 引数として渡されたパッケージ情報を使用
    target_package = version_info

    prompt = f"""# ペルソナ設定

あなたはWebアプリケーションセキュリティ専門家として、以下の専門知識を持って分析を行ってください：

## あなたの専門領域
- **CVE脆弱性分析**: NVDデータベースの詳細解釈とCVSS評価
- **依存関係セキュリティ**: npm, yarn, composer, gem, maven等の脆弱性追跡
- **攻撃手法**: ReDoS, RCE, XSS, SQLインジェクション等の実攻撃パターン
- **リスク評価**: 実際の攻撃可能性とビジネス影響度の総合判定
- **多言語対応**: JavaScript, TypeScript, PHP, Python, Ruby, Java等での脆弱性パターン識別

---

# 脆弱性影響分析タスク

## 事前準備: システム情報の確認

**重要**: 分析開始前に、リポジトリのプロジェクト情報ドキュメントを探してください。

**候補ファイル**（見つかったものを読んでください。複数見つかった場合は複数読んでOK）：

**AI向け設定ファイル**:
- `.cursorrules` (Cursor AI)
- `.clinerules` (Cline)
- `.windsurfrules` (Windsurf)
- `.continuerules` (Continue)
- `.aider.conf.yml` (Aider)
- `CLAUDE.md`, `.claude.md` (Claude Code)
- `GEMINI.md` (Gemini)
- `AGENTS.md` (Codex)
- `.aidigest` (汎用AI向け)
- `AI.md` (汎用AI向け)

**一般プロジェクト情報**:
- `README.md` (プロジェクト概要)
- `ARCHITECTURE.md` (アーキテクチャ設計書)
- `docs/README.md`, `doc/README.md` (ドキュメント)

**分析手順**:
- 上記ファイルを探し、見つかったファイルを読み込む
- ファイルが見つかった場合 → システム固有の情報（アーキテクチャ、技術スタック、セキュリティガイドライン、使用パッケージの用途等）を抽出し、分析に活用
- どのファイルも見つからない場合 → リポジトリ構造から推測できる範囲でシステム情報を把握し、汎用的な分析を実行
- 出力言語は日本語としてください

## 分析対象

**対象パッケージ**: {target_package["package"] if target_package else 'パッケージ名を特定できませんでした'}

**CVE脆弱性詳細**:
"""

    if vuln_data:
        # CVEが多すぎる場合は警告を追加
        if len(vuln_data) > 5:
            prompt += f"\n**注意**: {len(vuln_data)}件のCVEが検出されています。主要なものに焦点を当てて分析してください。\n\n"

        for vuln in vuln_data:
            severity_jp = translate_severity_to_japanese(vuln['severity'])
            # descriptionを300文字に制限してプロンプトの肥大化を防ぐ
            description = vuln['description'][:300] + ('...' if len(vuln['description']) > 300 else '')
            prompt += f"""
### {vuln['id']} - {severity_jp}
**詳細**: {description}
**公開日**: {vuln.get('published', '不明')[:10]}
"""
    else:
        prompt += "CVE情報は取得できませんでしたが、パッケージアップデートの影響分析を行います。\n"

    # 前回分析結果セクション
    previous_section = ""
    if previous_analysis:
        previous_section = f"""

## 📝 前回の分析結果（参考）

以下は、同じPRに対する前回の分析結果です。今回の分析では、この情報を参考にしつつ、新しい視点や追加情報があれば含めてください。

```
{previous_analysis}
```

**注意**: 前回分析を参考にしつつも、独自の新しい分析を提供してください。単純なコピーは避けてください。

---
"""

    # 追加指示セクション
    additional_section = ""
    if additional_comment:
        additional_section = f"""

## 💬 追加の分析指示

ユーザーから以下の追加指示がありました。この指示を特に重視して分析してください：

**指示内容**: {additional_comment}

---
"""

    prompt += previous_section
    prompt += additional_section

    prompt += f"""

## 分析指示

**重要**: 分析は**指摘されたCVEのみ**に焦点を当ててください。以下のCVEに関連しない一般的なセキュリティ提案（例：セキュリティ監査体制の構築、ワークフロー追加など）は含めないでください。

現在のディレクトリでコードベース全体の専門的セキュリティ分析を実行してください。

### 1. 指摘CVEの脆弱機能の詳細特定
- **このPRで指摘されたCVEのみ**の脆弱関数・メソッドを特定
- 攻撃に必要な**具体的条件**（入力パターン、設定値等）を解析
- **攻撃ベクター**（ReDoS, RCE, パストラバーサル等）を明確化

### 2. 対象CVEに関連する使用箇所の徹底検索
**検索対象**:
- 依存関係ファイル: package.json, package-lock.json, yarn.lock, composer.json, pom.xml, Gemfile等
- 実装ファイル: 全言語ファイル（.js, .ts, .php, .py, .rb, .java等）

**検索方法**:
- パッケージのimport/require文
- 脆弱機能の直接的な呼び出し
- 間接的な依存関係経由での使用

### 3. 攻撃経路の実現可能性評価

#### 高リスク条件
- ユーザー入力が直接脆弱機能に渡される
- 外部API経由のデータが未検証で処理される
- ファイルアップロード・パターンマッチング処理がある

#### 中リスク条件
- 間接的にユーザー制御可能なデータが処理される
- 管理者権限でのみ到達可能な箇所での使用

#### 低リスク条件
- 完全に内部データのみで使用
- 既に適切なバリデーション・サニタイズで保護済み

### 4. システム固有のリスク評価
**各種AI向け設定ファイルの情報を活用して以下を評価**:
- システムアーキテクチャ上の影響度
- 機密データや重要業務への影響
- 既存のセキュリティ対策との兼ね合い
- 業務継続性への影響

## 出力形式（絶対遵守）

**重要**: 思考過程のログは出力しないでください。

あなたの応答は必ず次の「---RISK_ASSESSMENT_START---」から「---RISK_ASSESSMENT_END---」までの構造化ヘッダーで開始してください。構造化ヘッダは必ずコメントアウト（<!-- 〜〜〜 -->）したうえで出力してください。この出力はPythonコードでパースされます。

---RISK_ASSESSMENT_START---
RISK_LEVEL: [極低/低/中/高/Critical のいずれか]
CONFIDENCE: [高/中/低]
PRIMARY_REASON: [判定理由を1行（100文字以内）で簡潔に]
---RISK_ASSESSMENT_END---


**ヘッダーの記入例（ここから）**:
<!--
---RISK_ASSESSMENT_START---
RISK_LEVEL: 極低
CONFIDENCE: 高
PRIMARY_REASON: 脆弱パッケージ未使用、既にパッチ適用済み、攻撃経路なし
---RISK_ASSESSMENT_END---
-->
**ヘッダーの記入例（ここまで）**:

構造化ヘッダーの後に、以下の詳細分析を記述してください：

```markdown
<details><summary>クリックして展開</summary>

### システム概要
[各種AI向け設定ファイルから読み取ったシステム情報の要約]

### 脆弱機能の特定
- **対象関数/メソッド**: [具体的な関数名]
- **攻撃条件**: [具体的な入力パターンや設定]
- **攻撃手法**: [ReDoS/RCE/XSS等]

### 使用箇所の発見
- **発見箇所**: [ファイルパス:行数]
- **使用パターン**: [実際のコード抜粋]
- **データフロー**: [入力→処理→出力の流れ]

### 攻撃可能性評価
- **攻撃経路**: [具体的な攻撃シナリオ]
- **必要条件**: [攻撃に必要な前提条件]
- **実現可能性**: [高/中/低 + 理由]

### システム固有リスク
[各種AI向け設定ファイルの情報に基づく具体的影響評価]

### 総合リスク判定
**リスクレベル**: [緊急/高/中/低]
**判定理由**: [技術的根拠と業務影響を含む総合判断]

### 推奨対策
1. **即時対応**: [緊急度の高い対策]
2. **恒久対策**: [根本的な解決策]
3. **監視強化**: [追加のセキュリティ監視]

### 次善策（リスクが残存する場合あり）
[推奨対策が実施できない場合の次善策および次善策を採用した場合のリスク]
</details>
```

**⚠️ 絶対遵守すべき出力要件**:

1. **文字数制約**: あなたの応答は**1500-2500文字程度**が目安です。簡潔かつ要点を押さえた分析を提供してください。

2. **必須項目 - 各セクションに以下を含めること**:
   - **CVE脆弱機能詳細分析**: 200-300文字、脆弱な関数の説明
   - **使用箇所の発見**: 200-300文字、実際のファイルパスと行数
   - **攻撃可能性評価**: 300-400文字、具体的な攻撃シナリオ
   - **システム固有リスク**: 200-300文字、各種AI向け設定ファイルの情報に基づく分析
   - **総合リスク判定**: 200-300文字、技術的根拠を含む判断
   - **推奨対策**: 200-400文字、**このCVEに対する具体的対策のみ**、対策が有効である根拠も含めること
   - **次善策**: 200-400文字、**このCVEに対する具体的対策のみ**、対策が有効である根拠も含めること

3. **具体例の義務化**:
   - すべての関数名、メソッド名を明記
   - すべてのファイルパスを `ファイル名:行数` 形式で記載
   - すべてのコードスニペットを ```言語名 ブロックで記載
   - すべての攻撃シナリオに具体的なペイロード例を含める

4. **禁止事項**:
   - ❌ 「詳細は省略」「要約すると」などの短縮表現
   - ❌ 「[ここに詳細]」のようなプレースホルダー
   - ❌ 一般論のみの記述
   - ❌ 箇条書きのみの簡潔な記述

5. **記述スタイル**:
   - ✅ 各ポイントに段落形式の詳細説明を追加
   - ✅ 技術的根拠を必ず含める
   - ✅ システム固有の実装パターンを具体的に言及
   - ✅ 代替実装案をコード付きで提示

**例（攻撃シナリオセクション）**:
```
### 攻撃可能性評価

#### 攻撃経路の詳細分析

CVE-2024-4068のbracesパッケージの脆弱性を悪用する攻撃は、以下の具体的なステップで実行可能です：

【ステップ1: 脆弱性の特定】
攻撃者はまず、ターゲットアプリケーションがbracesパッケージのparse.js内のexpand()関数を使用していることを特定します。この関数は...（300文字以上の詳細）

【ステップ2: ペイロード作成】
攻撃者は大量のブレースを含むペイロードを作成します。このペイロードが処理されると...（詳細説明）

【ステップ3: 実際の攻撃】
攻撃者は以下のHTTPリクエストを送信します...（具体的な例）
```

このような詳細度で**全セクション**を記述してください。

システム固有の実装パターンや制約を必ず考慮し、実用的で具体的な分析結果を提供してください。
"""

    return prompt


def create_followup_question_prompt(vuln_data: List[Dict[str, Any]], previous_analysis: str, question: str) -> str:
    """前回分析への追加質問用のプロンプトを作成

    Args:
        vuln_data: 脆弱性データのリスト
        previous_analysis: 前回の分析結果
        question: ユーザーからの追加質問
    """

    cve_info = ""
    if vuln_data:
        cve_list = ", ".join([v['id'] for v in vuln_data])
        cve_info = f"**対象CVE**: {cve_list}"

    prompt = f"""# セキュリティ分析の追加質問対応

## 前回の分析結果

以下は、このPRに対して既に実施した脆弱性分析の結果です：

```
{previous_analysis}
```

{cve_info}

## ユーザーからの追加質問

ユーザーから以下の追加質問がありました。前回の分析結果を踏まえて、この質問に的確に回答してください：

**質問**: {question}

## 回答の指示

1. **前回分析の要約は不要**: 既に前回分析結果が共有されているので、全体を繰り返す必要はありません

2. **質問に直接回答**: ユーザーの質問に対して、セキュリティ専門家として明確に回答してください

3. **必要に応じて補足**: 質問に答えるために、追加のコードベース分析や技術的な調査が必要な場合は実施してください

4. **具体的な根拠を提示**: 回答には技術的な根拠や、必要に応じてコード例、ファイルパス、具体的な攻撃シナリオなどを含めてください

5. **構造化ヘッダーは不要**: この回答は追加質問への対応なので、構造化ヘッダー（RISK_ASSESSMENT_START など）は使用しないでください

6. **簡潔かつ明確に**: 質問への回答を中心に、必要な情報を過不足なく提供してください

## 回答例の構造

以下のような構造で回答してください：

```markdown
## 回答

[質問への直接的な回答]

### 技術的根拠

[回答を裏付ける技術的な詳細]

### 具体例・コード確認

[必要に応じて、コードベースの確認結果や具体例]

### 推奨アクション（必要な場合）

[質問に関連する推奨事項があれば記載]
```

前回の分析結果とシステムの状況を考慮して、ユーザーの質問に回答してください。
"""

    return prompt
