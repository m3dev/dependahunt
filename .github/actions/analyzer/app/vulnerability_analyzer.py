#!/usr/bin/env python3
"""
Dependabotè„†å¼±æ€§åˆ†æã‚¹ã‚¯ãƒªãƒ—ãƒˆ
GitHub APIã‹ã‚‰å–å¾—ã—ãŸDependabot PRæƒ…å ±ã‚’AI APIã§åˆ†æã™ã‚‹
"""

import json
import sys
import os
import urllib.error
from typing import List, Tuple

# ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from ai_providers import create_ai_provider
from github_api import (
    get_pr_details, extract_cve_numbers, find_cves_by_package_and_version,
    get_previous_analysis, add_cve_info_to_pr, post_github_comment
)
from cve_analyzer import get_nvd_vulnerability_info
from version_utils import extract_version_info
from prompt_builder import create_ai_analysis_prompt
from risk_assessment import extract_risk_from_ai_analysis
from formatters import format_github_comment, format_cve_info_section
from config import get_env_int


def analyze_vulnerabilities_with_ai(pr_body: str, repo: str = None, github_token: str = None,
                                    additional_comment: str = None, previous_analysis: str = None) -> str:
    """è„†å¼±æ€§æƒ…å ±ã‚’NVDã‹ã‚‰å–å¾—ã—ã¦ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹åˆ†æã‚’å®Ÿè¡Œ"""
    cve_info_list = []  # [(cve_id, alert_number, alert_url), ...]

    # æ­£æ”»æ³•: Dependabotã‚¢ãƒ©ãƒ¼ãƒˆã‹ã‚‰å–å¾—
    if repo and github_token:
        print(f"ğŸ” Dependabotã‚¢ãƒ©ãƒ¼ãƒˆã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã¾ã™ï¼ˆrepo={repo}ï¼‰")
        version_info = extract_version_info(pr_body)
        if version_info:
            print(f"   âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±æŠ½å‡ºæˆåŠŸ: {version_info}")
            cve_info_list = find_cves_by_package_and_version(
                repo,
                version_info['package'],
                version_info['from'],
                version_info['to'],
                github_token
            )
        else:
            print(f"   âš ï¸ PRæœ¬æ–‡ã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ")
            print(f"   PRæœ¬æ–‡ã®æœ€åˆã®200æ–‡å­—: {pr_body[:200]}")

    # è£œåŠ©çš„: PRæœ¬æ–‡ï¼ˆchangelogç­‰ï¼‰ã«CVEç•ªå·ãŒã‚ã‚‹å ´åˆã¯ãã¡ã‚‰ã‚‚ä½¿ç”¨
    if not cve_info_list:
        print("â„¹ï¸ Dependabotã‚¢ãƒ©ãƒ¼ãƒˆã‹ã‚‰å–å¾—ã§ããªã‹ã£ãŸãŸã‚ã€PRæœ¬æ–‡ã‹ã‚‰CVEç•ªå·ã‚’æ¤œç´¢ã—ã¾ã™")
        print(f"ğŸ“„ PRæœ¬æ–‡ã®é•·ã•: {len(pr_body)} æ–‡å­—")
        print(f"ğŸ“„ PRæœ¬æ–‡ã®æœ€åˆã®500æ–‡å­—:")
        print(pr_body[:500])
        print(f"ğŸ“„ PRæœ¬æ–‡ã®æœ€å¾Œã®500æ–‡å­—:")
        print(pr_body[-500:])
        cve_numbers = extract_cve_numbers(pr_body)
        # CVEç•ªå·ã®ã¿ã®å ´åˆã¯ã€ã‚¢ãƒ©ãƒ¼ãƒˆç•ªå·ã¨URLã¯ç©º
        cve_info_list = [(cve, 0, '') for cve in cve_numbers]
        print(f"ğŸ” æŠ½å‡ºã•ã‚ŒãŸCVE: {cve_numbers if cve_numbers else '(ãªã—)'}")

    # CVEç•ªå·ã®ã¿ã®ãƒªã‚¹ãƒˆã‚’ä½œæˆï¼ˆé‡è¤‡é™¤å»ï¼‰
    cves = list(dict.fromkeys([cve_id for cve_id, _, _ in cve_info_list]))

    if len(cve_info_list) > len(cves):
        print(f"â„¹ï¸ CVEé‡è¤‡ã‚’é™¤å»: {len(cve_info_list)}ä»¶ â†’ {len(cves)}ä»¶")

    # å…¨CVEæƒ…å ±ã‚’åé›†
    all_vuln_data = []
    if cves:
        for cve in cves:
            print(f"CVEæƒ…å ±ã‚’å–å¾—ä¸­: {cve}...")
            vuln_info = get_nvd_vulnerability_info(cve)
            if 'error' not in vuln_info:
                all_vuln_data.append(vuln_info)

    # AIåˆ†æç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
    ai_prompt = create_ai_analysis_prompt(all_vuln_data, pr_body,
                                          additional_comment, previous_analysis)

    # AIåˆ†æã‚’å®Ÿè¡Œ
    ai_analysis = run_ai_analysis(ai_prompt)

    # AIåˆ†æçµæœã‹ã‚‰å®Ÿéš›ã®ãƒªã‚¹ã‚¯è©•ä¾¡ã‚’æŠ½å‡º
    actual_risk_assessment = extract_risk_from_ai_analysis(ai_analysis, all_vuln_data, cves)

    result = ""
    if not cves:
        result += "**æ³¨è¨˜**: ã“ã®PRã«ã¯CVEç•ªå·ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ãŒã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®åˆ†æã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚\n\n"
    elif not all_vuln_data:
        result += "**æ³¨è¨˜**: CVEæƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸãŒã€ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹åˆ†æã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚\n\n"

    # çµæœã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    result += f"""## ğŸ¯ çµè«–ãƒ»å®Ÿéš›ã®ãƒªã‚¹ã‚¯åˆ¤å®š

{actual_risk_assessment}

---

## ğŸ”’ è©³ç´°åˆ†æçµæœ

"""

    result += ai_analysis
    result += "\n\n---\n\n"

    # CVEåŸºæœ¬æƒ…å ±ï¼ˆãƒªãƒ³ã‚¯ä»˜ãï¼‰
    result += format_cve_info_section(all_vuln_data)

    return result


def run_ai_analysis(prompt: str) -> str:
    """AI APIã‚’ä½¿ã£ã¦åˆ†æã‚’å®Ÿè¡Œ

    Args:
        prompt: åˆ†æãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ

    Returns:
        åˆ†æçµæœ
    """
    try:
        # AIãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’ä½œæˆ
        provider_type = os.getenv('INPUT_AI_PROVIDER')
        if not provider_type:
            raise ValueError("INPUT_AI_PROVIDERç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")

        ai_provider = create_ai_provider(
            provider_type=provider_type,
            anthropic_api_key=os.getenv('INPUT_ANTHROPIC_API_KEY'),
            vertex_project_id=os.getenv('INPUT_VERTEX_PROJECT_ID'),
            vertex_region=os.getenv('INPUT_VERTEX_REGION'),
            gemini_api_key=os.getenv('INPUT_GEMINI_API_KEY'),
            model=os.getenv('INPUT_AI_MODEL')
        )

        # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆç’°å¢ƒå¤‰æ•°ã§å¤‰æ›´å¯èƒ½ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ360ç§’ï¼‰
        timeout_seconds = get_env_int('INPUT_AI_TIMEOUT', 360)

        print(f"ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé•·: {len(prompt):,}æ–‡å­— ({len(prompt.encode('utf-8')):,}ãƒã‚¤ãƒˆ)")
        print(f"â° ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š: {timeout_seconds}ç§’")
        print(f"ğŸ¤– AIãƒ—ãƒ­ãƒã‚¤ãƒ€: {ai_provider.get_provider_name()}")

        # AIåˆ†æã‚’å®Ÿè¡Œ
        result = ai_provider.analyze(prompt, timeout_seconds)

        debug_mode = os.getenv('DEBUG_MODE') == '1'
        if debug_mode:
            print("\n" + "="*80)
            print("ğŸ” DEBUG: AI APIã‹ã‚‰ã®æˆ»ã‚Šå€¤")
            print("="*80)
            print(f"Result length: {len(result)} chars")
            print(f"Result preview: {result[:500]}")
            print("="*80 + "\n")

        if not result.strip():
            print("âš ï¸  è­¦å‘Š: AI APIã®å‡ºåŠ›ãŒç©ºã§ã™")
            return "âŒ **AIåˆ†æå¤±æ•—: AI APIã®å‡ºåŠ›ãŒç©ºã§ã—ãŸ**\n\nåˆ†æã‚’å®Œäº†ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:\n- AI APIã®æ¥ç¶šçŠ¶æ…‹\n- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å†…å®¹ã¨é•·ã•\n- APIã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™"

        print(f"âœ… AIåˆ†ææˆåŠŸ ({len(result)} chars)")
        return result.strip()

    except TimeoutError as e:
        print(f"â±ï¸  AIåˆ†æãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ: {str(e)}")
        return f"âŒ **AIåˆ†æå¤±æ•—: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**\n\nã‚¨ãƒ©ãƒ¼è©³ç´°: {str(e)}\n\nåˆ†æã‚’å®Œäº†ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:\n- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šã®è¦‹ç›´ã— (ç¾åœ¨: {timeout_seconds}ç§’)\n- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚µã‚¤ã‚ºã®å‰Šæ¸›\n- AI APIã®å¿œç­”é€Ÿåº¦"
    except ValueError as e:
        print(f"âŒ è¨­å®šã‚¨ãƒ©ãƒ¼: {str(e)}")
        return f"âŒ **AIåˆ†æå¤±æ•—: è¨­å®šã‚¨ãƒ©ãƒ¼**\n\nã‚¨ãƒ©ãƒ¼è©³ç´°: {str(e)}\n\nåˆ†æã‚’å®Œäº†ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:\n- INPUT_AI_PROVIDERç’°å¢ƒå¤‰æ•°ã®è¨­å®š\n- å„AIãƒ—ãƒ­ãƒã‚¤ãƒ€ã®èªè¨¼æƒ…å ± (APIã‚­ãƒ¼ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDç­‰)\n- ç’°å¢ƒå¤‰æ•°ã®å‘½åè¦å‰‡"
    except RuntimeError as e:
        print(f"âŒ AIåˆ†æã‚¨ãƒ©ãƒ¼: {str(e)}")
        return f"âŒ **AIåˆ†æå¤±æ•—: å®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼**\n\nã‚¨ãƒ©ãƒ¼è©³ç´°: {str(e)}\n\nåˆ†æã‚’å®Œäº†ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚APIã¨ã®é€šä¿¡ä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"
    except Exception as e:
        print(f"âŒ AIåˆ†æä¸­ã«äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼: {type(e).__name__}: {str(e)}")
        import traceback
        traceback.print_exc()
        return f"âŒ **AIåˆ†æå¤±æ•—: äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼**\n\nã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—: {type(e).__name__}\nã‚¨ãƒ©ãƒ¼è©³ç´°: {str(e)}\n\nåˆ†æã‚’å®Œäº†ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦å•é¡Œã‚’ç‰¹å®šã—ã¦ãã ã•ã„ã€‚"


def main():
    """ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
    import argparse

    parser = argparse.ArgumentParser(description='Dependabotè„†å¼±æ€§åˆ†æã‚¹ã‚¯ãƒªãƒ—ãƒˆ')
    parser.add_argument('repo', help='ãƒªãƒã‚¸ãƒˆãƒªå (ä¾‹: m3dev/XXXXXXX)')
    parser.add_argument('pr_number', type=int, help='PRç•ªå· (ä¾‹: 123)')
    parser.add_argument('--silent', action='store_true', help='çµæœã‚’æ¨™æº–å‡ºåŠ›ã«è¡¨ç¤ºã—ãªã„')
    parser.add_argument('--additional-comment',
                        type=str,
                        help='è¿½åŠ ã®åˆ†ææŒ‡ç¤ºã‚„ã‚³ãƒ¡ãƒ³ãƒˆ')
    parser.add_argument('--include-previous',
                        action='store_true',
                        help='å‰å›ã®åˆ†æçµæœã‚’å«ã‚ã¦å†è©•ä¾¡')

    args = parser.parse_args()

    repo = args.repo
    pr_number = args.pr_number
    silent_mode = args.silent

    # ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èªè¨¼æƒ…å ±ã‚’å–å¾—
    github_token = os.getenv('GITHUB_TOKEN')

    if not github_token:
        print("Error: GITHUB_TOKEN environment variable is required")
        sys.exit(1)

    print(f"\n=== Analyzing PR #{pr_number} in {repo} ===\n")
    try:
        # PRè©³ç´°ã‚’å–å¾—
        pr_data = get_pr_details(repo, pr_number, github_token)

        if not silent_mode:
            print(f"## Dependabot/Renovate PR Analysis: #{pr_number}")
            print(f"**Title**: {pr_data['title']}")
            print(f"**URL**: {pr_data['html_url']}")
            print()

        # CVEæƒ…å ±ã‚’PRæœ¬æ–‡ã«è¿½è¨˜ï¼ˆåˆ†æå‰ã«å®Ÿè¡Œï¼‰
        print("ğŸ“ CVEæƒ…å ±ã‚’PRæœ¬æ–‡ã«è¿½è¨˜ä¸­...")
        cve_info_list = []  # åˆæœŸåŒ–
        version_info = extract_version_info(pr_data['body'])
        if version_info:
            cve_info_list = find_cves_by_package_and_version(
                repo,
                version_info['package'],
                version_info['from'],
                version_info['to'],
                github_token
            )
            add_cve_info_to_pr(repo, pr_number, pr_data['body'], cve_info_list, github_token)
        else:
            print("âš ï¸ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æƒ…å ±ã‚’æŠ½å‡ºã§ããªã‹ã£ãŸãŸã‚ã€CVEæƒ…å ±ã®è¿½è¨˜ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™")

        # å‰å›ã®åˆ†æçµæœã‚’å–å¾—ï¼ˆå¿…è¦ãªå ´åˆï¼‰
        previous_analysis = None
        if args.include_previous:
            if not silent_mode:
                print("ğŸ“ å‰å›ã®åˆ†æçµæœã‚’å–å¾—ä¸­...")
            previous_analysis = get_previous_analysis(repo, pr_number, github_token)
            if previous_analysis:
                if not silent_mode:
                    print(f"âœ… å‰å›ã®åˆ†æçµæœã‚’å–å¾—ã—ã¾ã—ãŸï¼ˆ{len(previous_analysis)}æ–‡å­—ï¼‰")
            else:
                if not silent_mode:
                    print("â„¹ï¸ å‰å›ã®åˆ†æçµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ")

        # è„†å¼±æ€§åˆ†æ
        if not silent_mode:
            print("### è„†å¼±æ€§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ†æçµæœ")
            if args.additional_comment:
                print(f"è¿½åŠ æŒ‡ç¤º: {args.additional_comment}")
            if previous_analysis:
                print("å‰å›åˆ†æ: å«ã‚ã‚‹")

        analysis = analyze_vulnerabilities_with_ai(
            pr_data['body'],
            repo,
            github_token,
            args.additional_comment,
            previous_analysis
        )

        if not silent_mode:
            print(analysis)
            print("\n" + "="*50 + "\n")

        # GitHubã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
        print("GitHub PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ä¸­...")
        comment_body = format_github_comment(analysis, pr_number, pr_data['title'], repo, cve_info_list)
        success = post_github_comment(repo, pr_number, comment_body, github_token)

        if not success:
            print("âš ï¸ ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€åˆ†æã¯å®Œäº†ã—ã¦ã„ã¾ã™")

        if not silent_mode:
            print("### PR Body (Raw)")
            print(pr_data['body'])

    except urllib.error.URLError as e:
        print(f"Error fetching PR data: {e}")
        sys.exit(1)
    except Exception as e:
        print(f"Error: {e}")
        sys.exit(1)


if __name__ == "__main__":
    main()
