#!/usr/bin/env python3
"""
Dependabotè„†å¼±æ€§åˆ†æã‚¹ã‚¯ãƒªãƒ—ãƒˆ
GitHub APIã‹ã‚‰å–å¾—ã—ãŸDependabot PRæƒ…å ±ã‚’AI APIã§åˆ†æã™ã‚‹
"""

import sys
import os
import urllib.error
from typing import List, Dict

# ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from ai_providers import create_ai_provider
from github_api import (
    get_pr_details, find_cves_by_package_and_version,
    get_previous_analysis, mark_pr_as_analyzed, post_github_comment
)
from cve_analyzer import get_nvd_vulnerability_info
from version_utils import  extract_all_version_info
from prompt_builder import create_ai_analysis_prompt
from risk_assessment import extract_risk_from_ai_analysis
from formatters import format_github_comment, format_cve_info_section
from config import get_env_int


def analyze_vulnerabilities_with_ai(version_info: Dict[str, str], cves: List[str],
                                    additional_comment: str = None,
                                    previous_analysis: str = None) -> str:
    """è„†å¼±æ€§æƒ…å ±ã‚’NVDã‹ã‚‰å–å¾—ã—ã¦ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹åˆ†æã‚’å®Ÿè¡Œ

    Args:
        version_info: ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ± {'package': 'name', 'from': '1.0', 'to': '2.0'} (å¿…é ˆ)
        additional_comment: è¿½åŠ ã‚³ãƒ¡ãƒ³ãƒˆ
        previous_analysis: å‰å›ã®åˆ†æçµæœ
    """

    # å…¨CVEæƒ…å ±ã‚’åé›†
    all_vuln_data = []
    if cves:
        for cve in cves:
            print(f"CVEæƒ…å ±ã‚’å–å¾—ä¸­: {cve}...")
            vuln_info = get_nvd_vulnerability_info(cve)
            if 'error' not in vuln_info:
                all_vuln_data.append(vuln_info)

    # AIåˆ†æç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
    ai_prompt = create_ai_analysis_prompt(all_vuln_data, version_info,
                                          additional_comment, previous_analysis)

    # AIåˆ†æã‚’å®Ÿè¡Œ
    ai_analysis = run_ai_analysis(ai_prompt)

    # AIåˆ†æçµæœã‹ã‚‰å®Ÿéš›ã®ãƒªã‚¹ã‚¯è©•ä¾¡ã‚’æŠ½å‡º
    actual_risk_assessment = extract_risk_from_ai_analysis(ai_analysis, all_vuln_data, cves)

    result = ""
    if not cves:
        result += "**æ³¨è¨˜**: ã“ã®PRã«ã¯CVEç•ªå·ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ãŒã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®åˆ†æã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚\n\n"
    elif not all_vuln_data:
        result += "**æ³¨è¨˜**: CVEæƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸãŒã€ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹åˆ†æã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚\n\n"

    # çµæœã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    result += f"""## ğŸ¯ çµè«–ãƒ»å®Ÿéš›ã®ãƒªã‚¹ã‚¯åˆ¤å®š

{actual_risk_assessment}

---

## ğŸ”’ è©³ç´°åˆ†æçµæœ

"""

    result += ai_analysis
    result += "\n\n---\n\n"

    # CVEåŸºæœ¬æƒ…å ±ï¼ˆãƒªãƒ³ã‚¯ä»˜ãï¼‰
    result += format_cve_info_section(all_vuln_data)

    return result


def run_ai_analysis(prompt: str) -> str:
    """AI APIã‚’ä½¿ã£ã¦åˆ†æã‚’å®Ÿè¡Œ

    Args:
        prompt: åˆ†æãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ

    Returns:
        åˆ†æçµæœ
    """
    try:
        # AIãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’ä½œæˆ
        provider_type = os.getenv('INPUT_AI_PROVIDER')
        if not provider_type:
            raise ValueError("INPUT_AI_PROVIDERç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")

        ai_provider = create_ai_provider(
            provider_type=provider_type,
            anthropic_api_key=os.getenv('INPUT_ANTHROPIC_API_KEY'),
            vertex_project_id=os.getenv('INPUT_VERTEX_PROJECT_ID'),
            vertex_region=os.getenv('INPUT_VERTEX_REGION'),
            gemini_api_key=os.getenv('INPUT_GEMINI_API_KEY'),
            model=os.getenv('INPUT_AI_MODEL')
        )

        # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆç’°å¢ƒå¤‰æ•°ã§å¤‰æ›´å¯èƒ½ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ360ç§’ï¼‰
        timeout_seconds = get_env_int('INPUT_AI_TIMEOUT', 360)

        print(f"ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé•·: {len(prompt):,}æ–‡å­— ({len(prompt.encode('utf-8')):,}ãƒã‚¤ãƒˆ)")
        print(f"â° ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š: {timeout_seconds}ç§’")
        print(f"ğŸ¤– AIãƒ—ãƒ­ãƒã‚¤ãƒ€: {ai_provider.get_provider_name()}")

        # AIåˆ†æã‚’å®Ÿè¡Œ
        result = ai_provider.analyze(prompt, timeout_seconds)

        debug_mode = os.getenv('DEBUG_MODE') == '1'
        if debug_mode:
            print("\n" + "="*80)
            print("ğŸ” DEBUG: AI APIã‹ã‚‰ã®æˆ»ã‚Šå€¤")
            print("="*80)
            print(f"Result length: {len(result)} chars")
            print(f"Result preview: {result[:500]}")
            print("="*80 + "\n")

        if not result.strip():
            print("âš ï¸  è­¦å‘Š: AI APIã®å‡ºåŠ›ãŒç©ºã§ã™")
            return "âŒ **AIåˆ†æå¤±æ•—: AI APIã®å‡ºåŠ›ãŒç©ºã§ã—ãŸ**\n\nåˆ†æã‚’å®Œäº†ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:\n- AI APIã®æ¥ç¶šçŠ¶æ…‹\n- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å†…å®¹ã¨é•·ã•\n- APIã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™"

        print(f"âœ… AIåˆ†ææˆåŠŸ ({len(result)} chars)")
        return result.strip()

    except TimeoutError as e:
        print(f"â±ï¸  AIåˆ†æãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ: {str(e)}")
        return f"âŒ **AIåˆ†æå¤±æ•—: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**\n\nã‚¨ãƒ©ãƒ¼è©³ç´°: {str(e)}\n\nåˆ†æã‚’å®Œäº†ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:\n- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šã®è¦‹ç›´ã— (ç¾åœ¨: {timeout_seconds}ç§’)\n- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚µã‚¤ã‚ºã®å‰Šæ¸›\n- AI APIã®å¿œç­”é€Ÿåº¦"
    except ValueError as e:
        print(f"âŒ è¨­å®šã‚¨ãƒ©ãƒ¼: {str(e)}")
        return f"âŒ **AIåˆ†æå¤±æ•—: è¨­å®šã‚¨ãƒ©ãƒ¼**\n\nã‚¨ãƒ©ãƒ¼è©³ç´°: {str(e)}\n\nåˆ†æã‚’å®Œäº†ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:\n- INPUT_AI_PROVIDERç’°å¢ƒå¤‰æ•°ã®è¨­å®š\n- å„AIãƒ—ãƒ­ãƒã‚¤ãƒ€ã®èªè¨¼æƒ…å ± (APIã‚­ãƒ¼ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDç­‰)\n- ç’°å¢ƒå¤‰æ•°ã®å‘½åè¦å‰‡"
    except RuntimeError as e:
        print(f"âŒ AIåˆ†æã‚¨ãƒ©ãƒ¼: {str(e)}")
        return f"âŒ **AIåˆ†æå¤±æ•—: å®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼**\n\nã‚¨ãƒ©ãƒ¼è©³ç´°: {str(e)}\n\nåˆ†æã‚’å®Œäº†ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚APIã¨ã®é€šä¿¡ä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"
    except Exception as e:
        print(f"âŒ AIåˆ†æä¸­ã«äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼: {type(e).__name__}: {str(e)}")
        import traceback
        traceback.print_exc()
        return f"âŒ **AIåˆ†æå¤±æ•—: äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼**\n\nã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—: {type(e).__name__}\nã‚¨ãƒ©ãƒ¼è©³ç´°: {str(e)}\n\nåˆ†æã‚’å®Œäº†ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦å•é¡Œã‚’ç‰¹å®šã—ã¦ãã ã•ã„ã€‚"


def main():
    """ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
    import argparse

    parser = argparse.ArgumentParser(description='Dependabotè„†å¼±æ€§åˆ†æã‚¹ã‚¯ãƒªãƒ—ãƒˆ')
    parser.add_argument('repo', help='ãƒªãƒã‚¸ãƒˆãƒªå (ä¾‹: m3dev/XXXXXXX)')
    parser.add_argument('pr_number', type=int, help='PRç•ªå· (ä¾‹: 123)')
    parser.add_argument('--silent', action='store_true', help='çµæœã‚’æ¨™æº–å‡ºåŠ›ã«è¡¨ç¤ºã—ãªã„')
    parser.add_argument('--additional-comment',
                        type=str,
                        help='è¿½åŠ ã®åˆ†ææŒ‡ç¤ºã‚„ã‚³ãƒ¡ãƒ³ãƒˆ')
    parser.add_argument('--include-previous',
                        action='store_true',
                        help='å‰å›ã®åˆ†æçµæœã‚’å«ã‚ã¦å†è©•ä¾¡')
    parser.add_argument('--package-name',
                        type=str,
                        help='åˆ†æå¯¾è±¡ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åï¼ˆæŒ‡å®šã—ãªã„å ´åˆã¯å…¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼‰')

    args = parser.parse_args()

    repo = args.repo
    pr_number = args.pr_number
    silent_mode = args.silent

    # ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èªè¨¼æƒ…å ±ã‚’å–å¾—
    github_token = os.getenv('GITHUB_TOKEN')

    if not github_token:
        print("Error: GITHUB_TOKEN environment variable is required")
        sys.exit(1)

    print(f"\n=== Analyzing PR #{pr_number} in {repo} ===\n")
    try:
        # PRè©³ç´°ã‚’å–å¾—
        pr_data = get_pr_details(repo, pr_number, github_token)

        if not silent_mode:
            print(f"## Dependabot/Renovate PR Analysis: #{pr_number}")
            print(f"**Title**: {pr_data['title']}")
            print(f"**URL**: {pr_data['html_url']}")
            print()

        # å…¨ã¦ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æƒ…å ±ã‚’æŠ½å‡º
        all_version_info = extract_all_version_info(pr_data['body'])

        if not all_version_info:
            print("âš ï¸ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æƒ…å ±ã‚’æŠ½å‡ºã§ããªã‹ã£ãŸãŸã‚ã€å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™")
            return

        # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        if args.package_name:
            print(f"ğŸ” æŒ‡å®šã•ã‚ŒãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°: {args.package_name}")
            filtered_version_info = [v for v in all_version_info if v['package'] == args.package_name]

            if not filtered_version_info:
                print(f"âš ï¸ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ '{args.package_name}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ")
                print(f"ğŸ“¦ ã“ã®PRã«å«ã¾ã‚Œã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸:")
                for idx, version_info in enumerate(all_version_info, 1):
                    print(f"  {idx}. {version_info['package']}: {version_info['from']} â†’ {version_info['to']}")
                return

            all_version_info = filtered_version_info
            print(f"âœ… ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ '{args.package_name}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ")

        print(f"ğŸ“¦ åˆ†æå¯¾è±¡ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ•°: {len(all_version_info)}")
        for idx, version_info in enumerate(all_version_info, 1):
            print(f"  {idx}. {version_info['package']}: {version_info['from']} â†’ {version_info['to']}")

        # å„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ã¤ã„ã¦å€‹åˆ¥ã«åˆ†æãƒ»ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
        for idx, version_info in enumerate(all_version_info, 1):
            try:
                print(f"\n{'='*80}")
                print(f"ğŸ“¦ [{idx}/{len(all_version_info)}] {version_info['package']} ã®åˆ†æã‚’é–‹å§‹")
                print(f"{'='*80}\n")

                # CVEæƒ…å ±ã®å–å¾—ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆç”¨ï¼‰
                cve_info_list = find_cves_by_package_and_version(
                    repo,
                    version_info['package'],
                    version_info['from'],
                    version_info['to'],
                    github_token
                )

                # å‰å›ã®åˆ†æçµæœã‚’å–å¾—ï¼ˆå¿…è¦ãªå ´åˆï¼‰
                previous_analysis = None
                if args.include_previous:
                    if not silent_mode:
                        print(f"ğŸ“ å‰å›ã®åˆ†æçµæœã‚’å–å¾—ä¸­... ({version_info['package']})")
                    previous_analysis = get_previous_analysis(repo, pr_number, version_info['package'], github_token)
                    if previous_analysis:
                        if not silent_mode:
                            print(f"âœ… å‰å›ã®åˆ†æçµæœã‚’å–å¾—ã—ã¾ã—ãŸ\n{previous_analysis[:200]}...\n")
                    else:
                        if not silent_mode:
                            print("â„¹ï¸ å‰å›ã®åˆ†æçµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ")

                # è„†å¼±æ€§åˆ†æ
                if not silent_mode:
                    print(f"### è„†å¼±æ€§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ†æçµæœ ({version_info['package']})")
                    if args.additional_comment:
                        print(f"è¿½åŠ æŒ‡ç¤º: {args.additional_comment}")
                    if previous_analysis:
                        print("å‰å›åˆ†æ: å«ã‚ã‚‹")

                analysis = analyze_vulnerabilities_with_ai(
                    version_info,
                    [cve_id for cve_id, _, _ in cve_info_list],
                    args.additional_comment,
                    previous_analysis
                )

                if not silent_mode:
                    print(analysis)
                    print("\n" + "="*50 + "\n")

                # GitHubã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ï¼ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã”ã¨ã«å€‹åˆ¥ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼‰
                print(f"GitHub PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ä¸­... ({version_info['package']})")
                comment_body = format_github_comment(
                    analysis,
                    pr_number,
                    pr_data['title'],
                    repo,
                    version_info,
                    cve_info_list
                )
                success = post_github_comment(repo, pr_number, comment_body, github_token)

                if not success:
                    print(f"âš ï¸ ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€åˆ†æã¯å®Œäº†ã—ã¦ã„ã¾ã™ ({version_info['package']})")
                else:
                    print(f"âœ… ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿å®Œäº† ({version_info['package']})")
            except Exception as e:
                print(f"âŒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ '{version_info['package']}' ã®åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
                
        # å…¨ã¦ã®åˆ†æãŒå®Œäº†ã—ãŸå¾Œã«ANALYZED_MARKERã‚’è¿½è¨˜
        mark_pr_as_analyzed(repo, pr_number, github_token)

        if not silent_mode:
            print("\n" + "="*80)
            print(f"âœ… å…¨ {len(all_version_info)} ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸ")
            print("="*80 + "\n")
            print("### PR Body (Raw)")
            print(pr_data['body'])

    except urllib.error.URLError as e:
        print(f"Error fetching PR data: {e}")
        sys.exit(1)
    except Exception as e:
        print(f"Error: {e}")
        sys.exit(1)


if __name__ == "__main__":
    main()
